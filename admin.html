<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin — Users</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:2rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #1b2233}
    button{background:#1f2937;color:#e5e7eb;border:1px solid #2b3443;border-radius:8px;padding:.35rem .6rem;cursor:pointer}
    .pill{font-size:.8rem;padding:.2rem .5rem;border-radius:999px;border:1px solid #2b3443;background:#0b1220}
  </style>
</head>
<body>
  <h1>Admin — Users</h1>
  <p id="status">Checking auth…</p>
  <table id="tbl" style="display:none">
    <thead><tr><th>Email</th><th>User ID</th><th>Roles</th><th>Banned?</th><th>Actions</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>

<script>
netlifyIdentity.init();

function needLogin(msg){
  document.getElementById('status').textContent = msg || 'Please log in (admin).';
  netlifyIdentity.open('login');
}

function render(list){
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  list.forEach(u=>{
    const tr = document.createElement('tr');
    const roles = (u.app_metadata?.roles||[]).join(', ') || '—';
    const banned = (u.app_metadata?.banned===true);
    tr.innerHTML = `
      <td>${u.email}</td>
      <td><code>${u.id}</code></td>
      <td><span class="pill">${roles}</span></td>
      <td>${banned? 'Yes':'No'}</td>
      <td>
        <button data-act="${banned?'unban':'ban'}" data-id="${u.id}">
          ${banned? 'Unban':'Ban'}
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('tbl').style.display = '';
  document.getElementById('status').textContent = '';
}

async function loadUsers(user){
  document.getElementById('status').textContent = 'Loading users…';
  const res = await fetch('/.netlify/functions/admin-list-users', {
    headers: { Authorization: 'Bearer ' + user.token.access_token }
  });
  if(res.status === 403){ needLogin('Not an admin.'); return; }
  if(!res.ok){ document.getElementById('status').textContent = 'Failed to load users.'; return; }
  const data = await res.json();
  render(data.users||[]);
}

async function act(user, id, action){
  const res = await fetch('/.netlify/functions/admin-ban', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization: 'Bearer ' + user.token.access_token
    },
    body: JSON.stringify({ id, action })
  });
  if(!res.ok){ alert('Action failed.'); return; }
  loadUsers(user);
}

document.getElementById('rows').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id, action = btn.dataset.act;
  const user = netlifyIdentity.currentUser();
  if(!user){ return needLogin(); }
  act(user, id, action);
});

netlifyIdentity.on('init', user=>{
  if(!user) return needLogin();
  loadUsers(user);
});
netlifyIdentity.on('login', user=>{ loadUsers(user); netlifyIdentity.close(); });
</script>
</body>
</html>
