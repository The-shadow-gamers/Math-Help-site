<script>
  // ... keep all other code ...

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    let text = "";
    try { text = await res.text(); } catch {}
    if (!res.ok) {
      console.error("Request failed", res.status, text);
      alert(`Broadcast failed (${res.status}): ${text || "No message"}`);
      return null;
    }
    try { return JSON.parse(text || "{}"); } catch (e) {
      console.warn("Non-JSON response:", text);
      return {};
    }
  }

  btnBroadcastMsg.addEventListener("click", async () => {
    const payload = {
      type: "message",
      style: msgStyle.value,
      level: msgLevel.value,
      text:  msgText.value.slice(0, 500),
      durationMs: Number(msgDur.value) || 8000
    };
    const out = await postJSON("/.netlify/functions/broadcast", payload);
    if (out) console.log("Broadcast message OK, id:", out.id);
  });

  btnBroadcastSound.addEventListener("click", async () => {
    const payload = { type: "sound", id: soundId.value };
    const out = await postJSON("/.netlify/functions/broadcast", payload);
    if (out) console.log("Broadcast sound OK, id:", out.id);
  });

  // Tiny status badge so you can see the poller working
  (function statusBadge(){
    const el = document.createElement("div");
    el.style.cssText = "position:fixed;bottom:.5rem;left:.5rem;font:12px ui-monospace;background:#0b1220;border:1px solid #1f2937;border-radius:8px;color:#cbd5e1;padding:.25rem .5rem;z-index:4000;opacity:.85";
    el.textContent = "events: -";
    document.body.appendChild(el);

    const _pollLoop = pollLoop;
    window.pollLoop = async function(){
      try{
        const r = await fetch(`/.netlify/functions/events?since=${cursor}&wait=15000`, { credentials:"include", cache:"no-store" });
        if (!r.ok) { el.textContent = `events: HTTP ${r.status}`; setTimeout(window.pollLoop, 1000); return; }
        const j = await r.json();
        el.textContent = `events: latest=${j.latest ?? "?"} new=${j.events?.length ?? 0}`;
        if (j.events && j.events.length) { j.events.forEach(ev => handleEvent(ev)); cursor = j.latest || cursor; }
      } catch(e){ el.textContent = "events: error"; }
      setTimeout(window.pollLoop, 0);
    };
  })();
</script>
