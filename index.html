<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Help</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- Default favicon -->
  <link id="favicon" rel="icon" type="image/png" href="icon.png" />

  <style>
    :root { --bar-h:56px; --bg:#0f172a; --panel:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --btn:#111827; --btnH:#1f2937; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{height:100%;display:grid;grid-template-rows:var(--bar-h) 1fr}

    /* Invisible unlock hotspot (top-left) */
    #hotspot{position:fixed;top:0;left:0;width:44px;height:44px;opacity:0;z-index:9999;cursor:pointer}

    /* Panel (hidden until unlocked) */
    .bar{display:none;align-items:center;gap:.5rem;padding:.5rem .75rem;
         background:linear-gradient(180deg,#121a2b,var(--panel));border-bottom:1px solid #0a0f1c}
    .bar.unlocked{display:flex}
    .brand{display:inline-flex;align-items:center;gap:.5rem;padding-right:.5rem;margin-right:.75rem;
           border-right:1px solid #0a0f1c;color:var(--muted);font-weight:700;user-select:none}
    .brand img{width:24px;height:24px;border-radius:6px}

    .btn{display:inline-flex;align-items:center;gap:.5rem;background:var(--btn);border:1px solid #0a0f1c;color:var(--text);
         padding:.4rem .6rem;border-radius:10px;cursor:pointer;transition:background .15s,transform .02s;white-space:nowrap}
    .btn:hover{background:var(--btnH)} .btn:active{transform:translateY(1px)}
    .btn img{width:18px;height:18px;border-radius:4px}
    .btn.clear{color:#fca5a5;border-color:#4b1010}
    .hint{margin-left:auto;color:var(--muted);font-size:.9rem}
    @media (max-width:780px){.hint{display:none}}

    iframe{width:100%;height:100%;border:none;background:#000}
  </style>
</head>
<body>
  <!-- Invisible unlock area (top-left corner) -->
  <div id="hotspot" aria-label="Open panel"></div>

  <div class="wrap">
    <div class="bar" id="panel">
      <span class="brand"><img src="icon.png" alt=""/>Math Help</span>

      <!-- Logo buttons -->
      <button class="btn" data-title="Calculator" data-favicon="calculator-icon.png">
        <img src="calculator-icon.png" alt="" /> Calculator
      </button>
      <button class="btn" data-title="Google" data-favicon="google-favicon.png">
        <img src="google-favicon.png" alt="" /> Google
      </button>
      <button class="btn" data-title="Google Docs" data-favicon="google-docs-icon.png">
        <img src="google-docs-icon.png" alt="" /> Google Docs
      </button>
      <button class="btn" data-title="Google Classroom" data-favicon="classroom-favicon.png">
        <img src="classroom-favicon.png" alt="" /> Classroom
      </button>
      <button class="btn" data-title="Khan Academy" data-favicon="khan-favicon.png">
        <img src="khan-favicon.png" alt="" /> Khan Academy
      </button>
      <button class="btn" data-title="Wikipedia" data-favicon="wikipedia-favicon.png">
        <img src="wikipedia-favicon.png" alt="" /> Wikipedia
      </button>

      <button class="btn clear" id="clearCloak">Clear</button>
      <span class="hint">Click a logo to change tab. “Clear” restores defaults.</span>
    </div>

    <!-- Proxied app will load after unlock -->
    <iframe id="app" title="Math Help"></iframe>
  </div>

  <script>
    const DEFAULT_TITLE = "Math Help";
    const DEFAULT_ICON  = "icon.png";
    const panel = document.getElementById("panel");
    const frame = document.getElementById("app");

    function getFaviconLink(){
      let link = document.querySelector('link[rel="icon"]');
      if(!link){ link = document.createElement('link'); link.rel='icon'; link.type='image/png'; document.head.appendChild(link); }
      return link;
    }
    function setTab(title, icon){ document.title = title; getFaviconLink().href = icon; }
    function clearTab(){ setTab(DEFAULT_TITLE, DEFAULT_ICON); }

    async function checkUnlocked(){
      try{
        const r = await fetch("/.netlify/functions/me", { credentials:"include", cache:"no-store" });
        const j = await r.json();
        return !!j.unlocked;
      }catch{ return false; }
    }

    async function unlockFlow(){
      const pass = prompt("Enter password:");
      if(!pass) return;
      try{
        const r = await fetch("/.netlify/functions/unlock", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({ password: pass })
        });
        const j = await r.json();
        if(j.ok){ reveal(); }
      }catch{}
    }

    function reveal(){
      panel.classList.add("unlocked");
      if(!frame.src) frame.src = "/app";  // Netlify proxy (keeps real URL out of HTML)
    }

    document.getElementById("hotspot").addEventListener("click", async () => {
      if(await checkUnlocked()) { reveal(); return; }
      await unlockFlow();
    });

    document.querySelectorAll('.btn[data-title]').forEach(btn => {
      btn.addEventListener('click', () => setTab(btn.dataset.title, btn.dataset.favicon));
    });
    document.getElementById('clearCloak').addEventListener('click', clearTab);

    clearTab();
    checkUnlocked().then(u => { if(u) reveal(); });
  </script>
</body>
</html>
