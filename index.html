<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Help</title>
<link rel="icon" href="icon.png" type="image/png" />

<style>
  /* ===== Design System ===== */
  :root{
    --bar-h:56px;
    --bg:#0b1220;
    --panel:#0f172a;
    --panel-2:#0c1426;
    --line:#0a0f1c;
    --text:#e7edf5;
    --muted:#9fb0c2;
    --brand:#cbd5ff;
    --btn:#162238;
    --btnH:#1b2a45;
    --accent:#5ea1ff;
    --accent2:#38bdf8;
    --radius:14px;
    --shadow:0 14px 40px rgba(0,0,0,.35);
    --focus:0 0 0 3px rgba(94,161,255,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  img{display:block}
  button,select,input,textarea{font:inherit;color:inherit}
  :focus-visible{outline:none; box-shadow:var(--focus)}
  @media (prefers-reduced-motion:reduce){ *{animation:none!important; transition:none!important}}

  /* ===== Down / Locked ===== */
  #locked{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#0a49c4,#053a97);
    color:#dbeafe; z-index:1000; text-align:center; padding:2rem;
  }
  #lockedInner{max-width:720px}
  #lockedIcon{width:64px; height:64px; border-radius:12px; margin:0 auto 12px}

  /* ===== Hotspot ===== */
  #hotspot{position:fixed; top:0; left:0; width:44px; height:44px; opacity:0; z-index:1500; cursor:pointer}

  /* ===== Top Bar ===== */
  .bar{
    display:none; flex-wrap:wrap; gap:.5rem; padding:.5rem .75rem;
    background:linear-gradient(180deg,#121a2b,var(--panel)); border-bottom:1px solid var(--line);
    position:fixed; top:0; left:0; right:0; z-index:1200;

    /* NEW: make the top menu bar scrollable ONLY */
    max-height:44vh;               /* lets it scroll if it wraps to multiple rows */
    overflow-y:auto;
    overscroll-behavior:contain;   /* keep scroll inside the bar */
    -webkit-overflow-scrolling:touch;
  }
  .bar.unlocked{display:flex}
  .bar-row{
    width:100%; display:flex; align-items:center; gap:.5rem;

    /* NEW: horizontal scrolling for narrow screens */
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .bar-left{display:flex; align-items:center; gap:.5rem}
  .bar-right{margin-left:auto; display:flex; gap:.5rem}
  .brand{display:inline-flex; align-items:center; gap:.5rem; padding-right:.6rem; margin-right:.8rem; border-right:1px solid var(--line); color:var(--brand); font-weight:800; letter-spacing:.2px; user-select:none}
  .brand img{width:22px; height:22px; border-radius:6px}
  .btn{display:inline-flex; align-items:center; gap:.5rem; background:var(--btn); border:1px solid var(--line); color:#e7edf5; padding:.45rem .7rem; border-radius:10px; cursor:pointer; transition:background .15s, transform .02s; white-space:nowrap}
  .btn:hover{background:var(--btnH)} .btn:active{transform:translateY(1px)}
  .btn img{width:18px; height:18px; border-radius:4px}
  .btn.clear{color:#fca5a5; border-color:#4b1010}
  .kbd{font:12px ui-monospace,monospace; background:var(--panel-2); border:1px solid #1f2937; padding:.1rem .35rem; border-radius:6px; color:#cbd5e1}
  #menuRestore{display:none; position:fixed; top:8px; right:8px; z-index:1300; background:#111827; border:1px solid #1f2937; color:#e5e7eb; border-radius:10px; padding:.35rem .55rem; cursor:pointer}
  body.bar-hidden #menuRestore{display:block}
  body.bar-hidden .bar{display:none!important}

  /* ===== Tools Drawer ===== */
  #toolsDrawer{position:fixed; top:var(--bar-h); right:0; bottom:0; width:360px; background:var(--panel); border-left:1px solid var(--line); transform:translateX(100%); transition:transform .18s ease; z-index:1250; overflow:auto; box-shadow:var(--shadow)}
  #toolsDrawer.open{transform:translateX(0)}
  #toolsHdr{display:flex; align-items:center; justify-content:space-between; padding:.65rem .8rem; background:var(--panel-2); border-bottom:1px solid var(--line)}
  .toolCard{padding:.8rem; border-bottom:1px solid var(--line)}
  .toolRow{display:flex; gap:.5rem; align-items:center; margin:.45rem 0}
  .input{flex:1; background:var(--panel-2); border:1px solid #111827; border-radius:10px; padding:.6rem .7rem; color:#e7edf5}
  .small{font-size:.85rem; color:var(--muted)}

  /* ===== Terminal ===== */
  #termDesk{display:none; position:fixed; inset:0; z-index:1400; background:rgba(0,0,0,.45)}
  #termBox{position:absolute; left:50%; top:10%; transform:translateX(-50%); width:min(900px,95vw); background:var(--panel); border:1px solid #101826; border-radius:14px; box-shadow:var(--shadow); overflow:hidden}
  #termTop{display:flex; align-items:center; justify-content:space-between; padding:.6rem .8rem; background:var(--panel-2); border-bottom:1px solid var(--line)}
  #termOut{height:320px; overflow:auto; padding:.8rem; font-family:ui-monospace,Menlo,Consolas,monospace; background:#0c1426}
  #termInRow{display:flex; gap:.5rem; align-items:center; padding:.6rem; border-top:1px solid var(--line)}
  #termIn{flex:1}

  /* ===== Embed Area ===== */
  #embedArea{position:fixed; top:var(--bar-h); left:0; right:0; bottom:0; z-index:100}
  #embedFrame{width:100%; height:100%; border:0; background:#000}
  #embedLoader{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:var(--panel)}
  #embedLoaderInner{text-align:center; max-width:320px}
  #embedLogo{width:100px; height:100px; border-radius:14px; margin:0 auto 12px}
  #embedProg{height:10px; border-radius:999px; background:#0f172a; border:1px solid #1b2233; overflow:hidden}
  #embedProg>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); animation:loading 2.2s infinite}
  @keyframes loading{0%{width:0%}50%{width:85%}100%{width:0%}}

  /* ===== Browser Window ===== */
  #browserDesk{display:none; position:fixed; left:0; right:0; top:var(--bar-h); bottom:0; z-index:1350; pointer-events:none}
  #browserWin{position:absolute; left:50%; top:18px; transform:translateX(-50%); width:min(1100px,96vw); height:min(80vh,calc(100vh - var(--bar-h) - 36px)); background:var(--panel); border:1px solid #101826; border-radius:14px; box-shadow:var(--shadow); overflow:hidden; pointer-events:auto}
  #browserTop{display:flex; align-items:center; justify-content:space-between; padding:.6rem .8rem; background:var(--panel-2); border-bottom:1px solid var(--line); cursor:move}
  #browserBody{position:absolute; inset:44px 0 0 0}
  #browserFrame{position:absolute; inset:0; border:0; width:100%; height:100%; background:#000}
  #browserLoader{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:var(--panel)}
  #browserLoaderInner{text-align:center; max-width:360px}
  #browserLogo{width:90px; height:90px; border-radius:14px; margin:0 auto 12px}
  #browserProg{height:10px; border-radius:999px; background:#0f172a; border:1px solid #1b2233; overflow:hidden}
  #browserProg>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#93c5fd); animation:loading 2.2s infinite}
  #browserErr{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:var(--panel); text-align:center; padding:1rem}
  #browserWin.full{top:0; left:0; transform:none; width:100vw; height:calc(100vh - var(--bar-h)); border-radius:0}
  #browserWin.half{top:0; right:0; left:auto; transform:none; width:50vw; height:calc(100vh - var(--bar-h)); border-radius:0}

  /* ===== Modals ===== */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000}
  .modal.show{display:flex}
  .modal .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
  .modal .card{position:relative; width:min(92vw,440px); background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:1rem; box-shadow:var(--shadow)}
  .modal h2{margin:.2rem 0 .4rem; font-weight:800; color:#c7d2fe}
  .modal p{margin:.2rem 0 .6rem; color:var(--muted)}
  .actions{display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem}
  .primary{background:#1f2937; border:1px solid #2b3443; color:#e5e7eb; padding:.6rem .9rem; border-radius:10px; cursor:pointer}
  .secondary{background:#0b1220; border:1px solid #1f2937; color:#94a3b8; padding:.6rem .9rem; border-radius:10px; cursor:pointer}
  .field{display:flex; flex-direction:column; gap:.35rem; margin:.6rem 0}
  .label{font-size:.9rem; color:#cbd5e1}
  .password-input{background:var(--panel-2); border:1px solid #111827; border-radius:10px; padding:.65rem .7rem; color:#e7edf5}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
  .choice{border:1px solid #1b2233; border-radius:12px; padding:.8rem; background:var(--panel-2); cursor:pointer; text-align:center}
  .choice:hover{border-color:#2a3958; background:#12203a}
  .choice h3{margin:.2rem 0 .3rem}
  .choice small{color:#9fb0c2}
</style>
</head>
<body>
  <!-- Restore button when menu is hidden -->
  <button id="menuRestore" class="btn" title="Show menu">â‰¡ Menu</button>

  <!-- Invisible password hotspot -->
  <div id="hotspot" aria-label="Open password"></div>

  <!-- Down screen -->
  <div id="locked" role="status" aria-live="polite">
    <div id="lockedInner">
      <img id="lockedIcon" src="down-favicon-64.png" alt="">
      <h1 style="margin:.25rem 0 .35rem">Math Help is down right now</h1>
      <p style="margin:0;opacity:.9">Please come back later.</p>
    </div>
  </div>

  <!-- Top menu -->
  <nav class="bar" id="panel" aria-label="Main menu">
    <div class="bar-row">
      <div class="bar-left">
        <span class="brand"><img id="brandIcon" src="down-favicon-32.png" alt="">Math Help</span>

        <!-- Tab cloak buttons -->
        <button class="btn" data-title="Calculator" data-favicon="calculator-icon.png"><img src="calculator-icon.png" alt="">Calculator</button>
        <button class="btn" data-title="Google" data-favicon="google-favicon.png"><img src="google-favicon.png" alt="">Google</button>
        <button class="btn" data-title="Google Docs" data-favicon="google-docs-icon.png"><img src="google-docs-icon.png" alt="">Docs</button>
        <button class="btn" data-title="Google Classroom" data-favicon="classroom-favicon.png"><img src="classroom-favicon.png" alt="">Classroom</button>
        <button class="btn" data-title="Khan Academy" data-favicon="khan-favicon.png"><img src="khan-favicon.png" alt="">Khan</button>
        <button class="btn" data-title="Wikipedia" data-favicon="wikipedia-favicon.png"><img src="wikipedia-favicon.png" alt="">Wikipedia</button>
        <button class="btn clear" id="clearCloak">Clear</button>

        <!-- Panic URL input -->
        <div style="display:flex;align-items:center;gap:.5rem;margin-left:.75rem">
          <label for="panicUrl">Panic URL (<span class="kbd">-</span>):</label>
          <input id="panicUrl" type="url" placeholder="https://example.com" style="width:220px" class="input" aria-label="URL opened when pressing minus">
        </div>

        <!-- Tools / Browser / Terminal -->
        <button id="toolsBtn" class="btn">Tools</button>
        <button id="openBrowser" class="btn">Browser</button>
        <button id="openTermBtn" class="btn">Terminal</button>
      </div>

      <div class="bar-right">
        <button id="collapseBtn" class="btn" aria-controls="panel" aria-expanded="true">Close Menu</button>
      </div>
    </div>

    <!-- Games row -->
    <div class="bar-row" style="border-top:1px solid var(--line); padding-top:.45rem; align-items:center">
      <span class="brand" style="border-right:none; margin-right:.25rem; padding-right:0; color:var(--muted)">Games</span>
      <button id="openBurrito" class="btn">Burrito Bison</button>
      <button id="openGolfHit" class="btn">Golf Hit</button>

      <!-- quick switches + chooser -->
      <button id="switchCool" class="btn" title="Switch to Cool UBG">Switch to UBG</button>
      <button id="switchMaths" class="btn" title="Switch to Mathsframe">Switch to Mathsframe</button>
      <button id="changeGamesSource" class="btn" title="Pick a source">Change Source</button>

      <!-- NOW PLAYING label (clickable) -->
      <span id="nowPlaying" class="small" role="button" tabindex="0"
            title="Click to change source"
            style="margin-left:.5rem; opacity:.85; cursor:pointer; user-select:none">
        Now playing: â€”
      </span>
    </div>
  </nav>

  <!-- Tools drawer -->
  <aside id="toolsDrawer" aria-hidden="true">
    <div id="toolsHdr">
      <h3 style="margin:0; font-weight:700">Tools</h3>
      <button id="toolsClose" class="btn" type="button">Close</button>
    </div>

    <div class="toolCard">
      <h4 style="margin:0 0 .4rem 0">Notepad</h4>
      <textarea id="noteArea" class="input" style="height:140px; resize:vertical" placeholder="Type notes..."></textarea>
      <div class="toolRow" style="justify-content:flex-end"><span id="noteSaved" class="small"></span></div>
    </div>

    <div class="toolCard">
      <h4 style="margin:0 0 .4rem 0">Timer</h4>
      <div class="toolRow">
        <input id="timerMin" class="input" type="number" min="0" max="180" value="25" style="width:90px" aria-label="Minutes">
        <button id="timerStart" class="btn" type="button">Start</button>
        <button id="timerStop" class="btn" type="button">Stop</button>
        <button id="timerReset" class="btn" type="button">Reset</button>
      </div>
      <div class="toolRow"><div id="timerReadout" style="font-size:1.4rem; font-weight:700">25:00</div></div>
    </div>
  </aside>

  <!-- Terminal -->
  <div id="termDesk" aria-hidden="true">
    <div id="termBox" role="dialog" aria-label="Terminal">
      <div id="termTop">
        <strong>Terminal</strong>
        <button id="termClose" class="btn" type="button">Close</button>
      </div>
      <pre id="termOut" aria-live="polite"></pre>
      <div id="termInRow">
        <input id="termIn" class="input" type="text" placeholder="Type ;help" aria-label="Terminal input" />
        <span style="color:var(--muted); font-size:.85rem">Enter â†µ</span>
      </div>
    </div>
  </div>

  <!-- Mini Browser Window -->
  <div id="browserDesk" aria-hidden="true">
    <div id="browserWin" role="dialog" aria-label="Browser window">
      <div id="browserTop" title="Drag â€¢ Double-click to toggle full/window">
        <div id="browserTitle">Browser</div>
        <div id="browserCtrls" style="display:flex; gap:.35rem">
          <button id="halfBtn" class="btn" title="Half screen">â–­â–­</button>
          <button id="fullBtn" class="btn" title="Full screen">â–¢</button>
          <button id="winBtn"  class="btn" title="Windowed">â–£</button>
          <button id="closeBtn" class="btn" title="Close">âœ•</button>
        </div>
      </div>
      <div id="browserBody">
        <iframe id="browserFrame" title="Mini Browser"></iframe>
        <div id="browserLoader">
          <div id="browserLoaderInner">
            <img id="browserLogo" src="icon.png" alt="Loading">
            <div id="browserProg"><span></span></div>
            <p class="small" style="text-align:center; margin-top:.6rem">Launchingâ€¦</p>
          </div>
        </div>
        <div id="browserErr">Couldnâ€™t load. The site may block iframes.</div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="pwModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h2 id="pwTitle">Enter Password</h2>
      <p>Unlock Math Help to continue.</p>
      <div class="field">
        <label class="label" for="pwInput">Password</label>
        <input id="pwInput" class="password-input" type="password" placeholder="Enter password" autocomplete="current-password" />
        <div id="pwError" class="small" style="min-height:1em; color:#fca5a5"></div>
      </div>
      <div class="actions">
        <button id="pwCancel" class="secondary" type="button">Cancel</button>
        <button id="pwSubmit" class="primary" type="button">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Browser Chooser Modal -->
  <div id="browserChooser" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="bcTitle">
      <h2 id="bcTitle">Open Browser</h2>
      <p>Pick where to browse:</p>
      <div class="grid-2" style="margin:.6rem 0">
        <button id="bcBean" class="choice" type="button"><h3>BeanBrowser</h3><small>Fast & minimal</small></button>
        <button id="bcWin" class="choice" type="button"><h3>Windows 11 Emulator</h3><small>Desktop-like experience</small></button>
      </div>
      <div class="actions"><button id="bcCancel" class="secondary" type="button">Cancel</button></div>
    </div>
  </div>

  <!-- Game Source Chooser Modal -->
  <div id="gameChooser" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="gsTitle">
      <h2 id="gsTitle">Choose Games Source</h2>
      <p>Where do you want to run games from?</p>
      <div class="grid-2" style="margin:.6rem 0">
        <button id="gsCool" class="choice" type="button">
          <h3>Cool UBG</h3>
          <small>Lots of unblocked games</small>
        </button>
        <button id="gsMaths" class="choice" type="button">
          <h3>Mathsframe</h3>
          <small>Fun games</small>
        </button>
      </div>
      <div class="actions">
        <button id="gsSkip" class="secondary" type="button">Not now</button>
      </div>
    </div>
  </div>

  <!-- Embed Area -->
  <section id="embedArea" aria-label="Embedded site">
    <iframe id="embedFrame" title="Embedded Site"></iframe>
    <div id="embedLoader" aria-hidden="true">
      <div id="embedLoaderInner">
        <img id="embedLogo" src="icon.png" alt="Loading">
        <div id="embedProg"><span></span></div>
        <p class="small" style="text-align:center; margin-top:.6rem">Loadingâ€¦</p>
      </div>
    </div>
  </section>

<script>
/* ===== Config ===== */
const EMBED_URL="https://mathhelp0g1.netlify.app/"; // fallback if skipping choice
const MINI_BROWSER_URL="https://win11-emu-react.vercel.app/";
const BEAN_URL="https://mbxp.vercel.app/";
const BURRITO_URL="/burrito/";          // opens in new tab
const ADMIN_PASSWORD="imadmin";
const USER_PASSWORD="gamerzforever";

/* Game sources (your links) */
const COOL_UBG_URL     = "https://mathhelp0g1.netlify.app/";
const MATHSFRAME_URL   = "https://mathhelpg1.netlify.app/";

/* ===== Elements ===== */
const hotspot=document.getElementById("hotspot");
const locked=document.getElementById("locked");
const panel=document.getElementById("panel");
const menuRestore=document.getElementById("menuRestore");
const collapseBtn=document.getElementById("collapseBtn");
const embedFrame=document.getElementById("embedFrame");
const embedLoader=document.getElementById("embedLoader");
const toolsDrawer=document.getElementById("toolsDrawer");
const toolsBtn=document.getElementById("toolsBtn");
const toolsClose=document.getElementById("toolsClose");
const noteArea=document.getElementById("noteArea");
const noteSaved=document.getElementById("noteSaved");
const timerMin=document.getElementById("timerMin");
const timerStart=document.getElementById("timerStart");
const timerStop=document.getElementById("timerStop");
const timerReset=document.getElementById("timerReset");
const timerReadout=document.getElementById("timerReadout");
const termDesk=document.getElementById("termDesk");
const termOut=document.getElementById("termOut");
const termIn=document.getElementById("termIn");
const termClose=document.getElementById("termClose");
const openTermBtn=document.getElementById("openTermBtn");
const openBrowserBtn=document.getElementById("openBrowser");
const browserDesk=document.getElementById("browserDesk");
const browserWin=document.getElementById("browserWin");
const browserTop=document.getElementById("browserTop");
const browserFrame=document.getElementById("browserFrame");
const browserLoader=document.getElementById("browserLoader");
const browserErr=document.getElementById("browserErr");
const closeBtn=document.getElementById("closeBtn");
const fullBtn=document.getElementById("fullBtn");
const halfBtn=document.getElementById("halfBtn");
const winBtn=document.getElementById("winBtn");
const brandIcon=document.getElementById("brandIcon");

/* Password modal */
const pwModal=document.getElementById("pwModal");
const pwInput=document.getElementById("pwInput");
const pwSubmit=document.getElementById("pwSubmit");
const pwCancel=document.getElementById("pwCancel");
const pwError=document.getElementById("pwError");

/* Browser chooser modal */
const bcModal=document.getElementById("browserChooser");
const bcBean=document.getElementById("bcBean");
const bcWin=document.getElementById("bcWin");
const bcCancel=document.getElementById("bcCancel");

/* Game source chooser modal */
const gsModal=document.getElementById("gameChooser");
const gsCool=document.getElementById("gsCool");
const gsMaths=document.getElementById("gsMaths");
const gsSkip=document.getElementById("gsSkip");

/* Quick switch & change buttons + label */
const switchCool=document.getElementById("switchCool");
const switchMaths=document.getElementById("switchMaths");
const changeGamesSource=document.getElementById("changeGamesSource");
const nowPlaying=document.getElementById("nowPlaying");

/* ===== Favicons / Tab Cloak core ===== */
let __iconVer=0; const __v=href=>href+(href.includes('?')?'&':'?')+'v='+(++__iconVer);
function removeFavicons(){ document.querySelectorAll('link[rel="icon"],link[rel="shortcut icon"],link[rel="apple-touch-icon"]').forEach(n=>n.remove()); }
function addIconWithSizes(href,s){ const l=document.createElement('link'); l.rel='icon'; l.type='image/png'; if(s) l.sizes=s; l.href=__v(href); document.head.appendChild(l); }
function addShortcutIcon(href){ const l=document.createElement('link'); l.rel='shortcut icon'; l.href=__v(href); document.head.appendChild(l); }
function setFavicons(icon){ removeFavicons(); if(typeof icon==='string'){ addIconWithSizes(icon,''); addShortcutIcon(icon); } else { let first=null; for(const [sz,href] of Object.entries(icon)){ addIconWithSizes(href,sz); if(!first) first=href; } if(first) addShortcutIcon(first); } }
function setTab(title,icon){ document.title=title; setFavicons(icon); }

/* ===== Tab Cloak persistence ===== */
function saveCloak(title, icon){ localStorage.setItem("mh_cloak", JSON.stringify({title, icon})); }
function loadCloak(){ try{ return JSON.parse(localStorage.getItem("mh_cloak")||"null"); }catch{ return null; } }
function clearCloak(){ localStorage.removeItem("mh_cloak"); setTab("Math Help","icon.png"); if(brandIcon) brandIcon.src="icon.png"; }
document.querySelectorAll('.btn[data-title]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const title = btn.getAttribute('data-title');
    const icon  = btn.getAttribute('data-favicon');
    setTab(title, icon);
    saveCloak(title, icon);
    if (brandIcon && icon && icon.endsWith('.png')) brandIcon.src = icon;
  });
});
document.getElementById('clearCloak')?.addEventListener('click', clearCloak);

/* ===== Initial DOWN state ===== */
function setInitialDown(){
  setTab("Math Help - Down",{"16x16":"down-favicon-16.png","32x32":"down-favicon-32.png","64x64":"down-favicon-64.png"});
  if(brandIcon) brandIcon.src="down-favicon-32.png";
  locked.style.display="flex";
  panel.classList.remove("unlocked");
  document.documentElement.style.setProperty("--bar-h","56px");
  if (nowPlaying) nowPlaying.textContent = "Now playing: â€”";
}
setInitialDown();

/* ===== Embed helpers & game source state ===== */
const GAMES_SRC_KEY = "mh_games_source";
function labelForUrl(url){
  if (!url) return "â€”";
  if (url.startsWith(COOL_UBG_URL)) return "UBG";
  if (url.startsWith(MATHSFRAME_URL)) return "Mathsframe";
  return url.includes("mathhelp0g1") ? "UBG"
       : url.includes("mathhelpg1")  ? "Mathsframe"
       : "Custom";
}
function setNowPlaying(url){
  if (nowPlaying) nowPlaying.textContent = "Now playing: " + labelForUrl(url);
}
function setGamesSource(url){
  localStorage.setItem(GAMES_SRC_KEY, url);
  setNowPlaying(url);
  loadEmbedded(url);
}
function getSavedGamesSource(){
  return localStorage.getItem(GAMES_SRC_KEY) || "";
}
function loadEmbedded(url){
  embedLoader.style.display="flex";
  embedFrame.removeAttribute('src');
  embedFrame.src=url;
  setTimeout(()=>{ embedLoader.style.display="none"; },1600);
}

/* ===== Unlock flow ===== */
function reveal(){
  locked.style.display="none";
  panel.classList.add("unlocked");
  const savedCloak = loadCloak();
  if (savedCloak && savedCloak.title && savedCloak.icon) {
    setTab(savedCloak.title, savedCloak.icon);
    if (brandIcon && savedCloak.icon.endsWith(".png")) brandIcon.src = savedCloak.icon;
  } else {
    setTab("Math Help","icon.png");
    if(brandIcon) brandIcon.src="icon.png";
  }
  const prev = getSavedGamesSource();
  if (prev) { setNowPlaying(prev); loadEmbedded(prev); }
  else { openGameChooser(); }
}

/* ===== Password Modal ===== */
function openPwModal(){ pwError.textContent=""; pwInput.value=""; pwModal.classList.add("show"); pwModal.setAttribute("aria-hidden","false"); setTimeout(()=> pwInput.focus(), 0); }
function closePwModal(){ pwModal.classList.remove("show"); pwModal.setAttribute("aria-hidden","true"); }
function submitPw(){
  const pw = pwInput.value.trim();
  if(pw===ADMIN_PASSWORD || pw===USER_PASSWORD){ closePwModal(); reveal(); }
  else{ pwError.textContent="Incorrect password."; pwInput.focus(); }
}
hotspot.addEventListener("click", openPwModal);
pwCancel.addEventListener("click", closePwModal);
pwSubmit.addEventListener("click", submitPw);
pwInput.addEventListener("keydown", e=>{ if(e.key==="Enter") submitPw(); });

/* ===== Menu show/hide ===== */
function setBarHeight(px){ document.documentElement.style.setProperty("--bar-h", px + "px"); }
function showMenu(){ document.body.classList.remove('bar-hidden'); if(!panel.classList.contains('unlocked')) return; requestAnimationFrame(()=> setBarHeight(panel.getBoundingClientRect().height || 0)); }
function hideMenu(){ document.body.classList.add('bar-hidden'); setBarHeight(0); }
collapseBtn?.addEventListener("click", hideMenu);
menuRestore?.addEventListener("click", showMenu);
window.addEventListener('resize',()=>{ if(panel.classList.contains('unlocked')) setBarHeight(panel.getBoundingClientRect().height || 0); });

/* ===== Panic: URL + minus key ===== */
const PANIC_URL_KEY = "mh_panic_url";
const panicUrlInput = document.getElementById("panicUrl");
(function initPanicUrl(){ const saved = localStorage.getItem(PANIC_URL_KEY) || ""; if (panicUrlInput) panicUrlInput.value = saved; })();
panicUrlInput?.addEventListener("change", ()=>{ localStorage.setItem(PANIC_URL_KEY, panicUrlInput.value.trim()); });
function resetToDown(){
  try { toolsDrawer.classList.remove("open"); } catch {}
  try { browserDesk.style.display = "none"; } catch {}
  try { termDesk.style.display = "none"; } catch {}
  try { embedFrame.removeAttribute("src"); } catch {}
  try { embedLoader.style.display = "none"; } catch {}
  setInitialDown();
}
document.addEventListener("keydown", (e)=>{
  const a = document.activeElement, typing = a && (a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.isContentEditable);
  if (typing) return;
  if (e.key === "-" || e.code === "Minus"){
    let url = (panicUrlInput?.value || "").trim();
    if (!url){ url = prompt("Enter a panic URL to open:"); if (!url) return; if (panicUrlInput) panicUrlInput.value = url; localStorage.setItem(PANIC_URL_KEY, url); }
    try { window.open(url, "_blank", "noopener"); } catch {}
    resetToDown();
  }
});

/* ===== Tools Drawer ===== */
function openTools(){ toolsDrawer.classList.add("open"); }
function closeTools(){ toolsDrawer.classList.remove("open"); }
toolsBtn.addEventListener("click",openTools);
toolsClose.addEventListener("click",closeTools);

/* ===== Notepad ===== */
noteArea.value=localStorage.getItem("mh_note")||"";
noteArea.addEventListener("input",()=>{ localStorage.setItem("mh_note",noteArea.value); noteSaved.textContent="Saved"; setTimeout(()=>noteSaved.textContent="",900); });

/* ===== Timer ===== */
let timerLeft=Number(timerMin.value)*60, timerId=null;
function renderTimer(){ const m=String(Math.floor(timerLeft/60)).padStart(2,"0"), s=String(timerLeft%60).padStart(2,"0"); timerReadout.textContent=`${m}:${s}`; }
function startTimer(){ if(timerId) return; timerId=setInterval(()=>{ if(timerLeft>0){ timerLeft--; renderTimer(); } else { clearInterval(timerId); timerId=null; alert("Time!"); }},1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function resetTimer(){ stopTimer(); timerLeft=Math.max(0,Math.min(180,Number(timerMin.value)))*60; renderTimer(); }
timerStart.addEventListener("click",startTimer);
timerStop.addEventListener("click",stopTimer);
timerReset.addEventListener("click",resetTimer);
timerMin.addEventListener("change",resetTimer);
renderTimer();

/* ===== Terminal ===== */
function openTerm(){ termDesk.style.display="block"; termIn.value=""; termIn.focus(); if(!termOut.textContent) termOut.textContent="Terminal ready. Type ;help\n"; }
function closeTerm(){ termDesk.style.display="none"; }
openTermBtn.addEventListener("click",openTerm);
termClose.addEventListener("click",closeTerm);
document.addEventListener("keydown",e=>{ if(termDesk.style.display==="block"&&e.key==="Escape"){ e.preventDefault(); closeTerm(); }});
function printLine(x=""){ const esc=x.replace(/</g,"&lt;").replace(/>/g,"&gt;"); termOut.innerHTML+=esc+"\n"; termOut.scrollTop=termOut.scrollHeight; }
function clearTerm(){ termOut.textContent=""; }
function handleCommand(s){
  const line=s.trim(); if(!line) return; printLine("> "+line);
  if(line===";help"){ printLine("Commands: ;help ;clear ;panic ;open tools ;close tools"); printLine(";browser open [url] ;browser close ;browser full ;browser half ;browser window"); return; }
  if(line===";clear"){ clearTerm(); return; }
  if(line===";panic"){ const u=(panicUrlInput?.value||"").trim(); if(u) { window.open(u,"_blank","noopener"); resetToDown(); } return; }
  if(line===";open tools"){ openTools(); return; }
  if(line===";close tools"){ closeTools(); return; }
  if(line===";browser open"){ openBrowserChooser(); return; }
  if(line.startsWith(";browser open ")){ openBrowser(line.slice(14).trim()||MINI_BROWSER_URL); return; }
  if(line===";browser close"){ closeBrowser(); return; }
  if(line===";browser full"){ makeFull(); return; }
  if(line===";browser half"){ makeHalf(); return; }
  if(line===";browser window"){ makeWindow(); return; }
  printLine("Unknown command. Try ;help");
}
termIn.addEventListener("keydown",e=>{ if(e.key==="Enter"){ handleCommand(e.target.value); e.target.value=""; }});

/* ===== Browser chooser ===== */
function openBrowserChooser(){ bcModal.classList.add("show"); bcModal.setAttribute("aria-hidden","false"); setTimeout(()=> bcBean.focus(), 0); }
function closeBrowserChooser(){ bcModal.classList.remove("show"); bcModal.setAttribute("aria-hidden","true"); }
openBrowserBtn.addEventListener('click', openBrowserChooser);
bcCancel.addEventListener('click', closeBrowserChooser);
bcBean.addEventListener('click', ()=>{ closeBrowserChooser(); openBrowser(BEAN_URL); });
bcWin.addEventListener('click',  ()=>{ closeBrowserChooser(); openBrowser(MINI_BROWSER_URL); });

/* ===== Mini browser window ===== */
let browserLoadTimer=null;
function resetBrowserInline(){ browserWin.style.left=''; browserWin.style.top=''; browserWin.style.right=''; browserWin.style.transform=''; }
function makeWindow(){ browserWin.classList.remove('full','half'); resetBrowserInline(); browserWin.style.left='50%'; browserWin.style.top='18px'; browserWin.style.transform='translateX(-50%)'; }
function makeFull(){ browserWin.classList.remove('half'); browserWin.classList.add('full'); resetBrowserInline(); }
function makeHalf(){ browserWin.classList.remove('full'); browserWin.classList.add('half'); resetBrowserInline(); }
function openBrowser(url){
  browserDesk.style.display="block"; browserDesk.setAttribute("aria-hidden","false");
  makeWindow(); browserErr.style.display="none"; browserLoader.style.display="flex";
  browserFrame.removeAttribute('src'); browserFrame.src=url;
  clearTimeout(browserLoadTimer); browserLoadTimer=setTimeout(()=>{ browserLoader.style.display="none"; browserErr.style.display="block"; },6000);
}
function closeBrowser(){ browserDesk.style.display="none"; browserDesk.setAttribute("aria-hidden","true"); }
closeBtn.addEventListener('click',closeBrowser);
fullBtn.addEventListener('click',makeFull);
halfBtn.addEventListener('click',makeHalf);
winBtn .addEventListener('click',makeWindow);
browserFrame.addEventListener('load',()=>{ clearTimeout(browserLoadTimer); browserLoader.style.display="none"; });

/* Drag (disabled in full/half) */
(function(){ let dragging=false,sx=0,sy=0,left=0,top=0;
  browserTop.addEventListener('mousedown',e=>{
    if(browserWin.classList.contains('full')||browserWin.classList.contains('half'))return;
    dragging=true; sx=e.clientX; sy=e.clientY;
    const r=browserWin.getBoundingClientRect(); left=r.left; top=r.top; document.body.style.userSelect="none";
  });
  window.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    browserWin.style.left=(left+dx)+"px"; browserWin.style.top=(top+dy)+"px"; browserWin.style.transform="translateX(0)";
  });
  window.addEventListener('mouseup',()=>{ if(dragging){ dragging=false; document.body.style.userSelect=""; }});
  browserTop.addEventListener('dblclick',()=>{ browserWin.classList.contains('full')?makeWindow():makeFull(); });
})();

/* ===== Games: existing buttons ===== */
document.getElementById("openBurrito").addEventListener("click",()=>{ window.open(BURRITO_URL,"_blank","noopener"); });
document.getElementById("openGolfHit").addEventListener("click",()=>{ window.open("golfhit.html","_blank","noopener"); });

/* ===== Game source chooser & switching ===== */
function openGameChooser(){
  gsModal.classList.add("show");
  gsModal.setAttribute("aria-hidden","false");
  setTimeout(()=> gsCool.focus(), 0);
}
function closeGameChooser(){
  gsModal.classList.remove("show");
  gsModal.setAttribute("aria-hidden","true");
}
gsCool.addEventListener('click', ()=>{ closeGameChooser(); setGamesSource(COOL_UBG_URL); });
gsMaths.addEventListener('click',()=>{ closeGameChooser(); setGamesSource(MATHSFRAME_URL); });
gsSkip.addEventListener('click', ()=>{ closeGameChooser(); setGamesSource(EMBED_URL); });

/* quick switches + change button */
switchCool.addEventListener('click', ()=> setGamesSource(COOL_UBG_URL));
switchMaths.addEventListener('click', ()=> setGamesSource(MATHSFRAME_URL));
changeGamesSource.addEventListener('click', openGameChooser);

/* NEW: make "Now playing" clickable (also with Enter/Space) */
nowPlaying.addEventListener('click', openGameChooser);
nowPlaying.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openGameChooser(); }
});

/* Helper for setTab also used above (kept for completeness) */
function setTab(title,icon){ document.title=title; setFavicons(icon); }
</script>
</body>
</html>
