<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Help</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icon.png" />

  <style>
    :root { --bar-h:56px; --bg:#0f172a; --panel:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
            --btn:#111827; --btnH:#1f2937; --accent:#2563eb; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{height:100%;display:grid;grid-template-rows:var(--bar-h) 1fr}
    .bar{height:var(--bar-h);display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-bottom:1px solid #0a0f1c;background:linear-gradient(180deg,#0f172a,#0a1222)}
    .bar .logo{display:flex;gap:.5rem;align-items:center;font-weight:700;color:#cbd5e1}
    .bar .logo img{width:28px;height:28px;border-radius:6px}
    .bar .spacer{flex:1}
    .btn{padding:.35rem .6rem;background:var(--btn);border:1px solid #1f2937;border-radius:10px;color:#e5e7eb;cursor:pointer}
    .btn:hover{background:var(--btnH)}
    .kbd{font:inherit;background:#0b1220;border:1px solid #1f2937;border-radius:6px;padding:.1rem .35rem;color:#9ca3af}
    .hint{color:#9ca3af;font-size:.9rem}

    #app{border:0;width:100%;height:100%;background:#000}

    /* Tools drawer */
    #toolsDrawer{position:fixed; top:var(--bar-h); right:0; width:320px; background:#0f172a; border-left:1px solid #0a0f1c;
                 transform:translateX(100%); transition:transform .18s ease; z-index:2500; overflow:auto;}
    #toolsDrawer.open{transform:translateX(0)}
    #toolsHdr{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;background:#0b1220;border-bottom:1px solid #0a0f1c}
    #toolsHdr h3{margin:0;font-size:1rem}
    .toolCard{padding:.8rem;border-bottom:1px solid #0a0f1c}
    .toolCard h4{margin:.2rem 0 .6rem 0}
    .toolRow{display:flex;gap:.5rem;align-items:center;margin:.4rem 0}

    /* Admin panel (only for admin) */
    #adminPanel{display:none; gap:.5rem; align-items:center; margin-left:1rem}
    #bgPick{width:120px;height:32px;padding:0;border-radius:8px;border:1px solid #1f2937;background:#0b1220}
    #bgUpload{display:none}
    #bgLabel{padding:.35rem .6rem;border:1px solid #1f2937;border-radius:10px;background:#111827;color:#e5e7eb;cursor:pointer}
    #bgClear{padding:.35rem .6rem;border:1px solid #1f2937;border-radius:10px;background:#111827;color:#e5e7eb;cursor:pointer}

    /* Whiteboard overlay */
    #wbDesk{display:none;position:fixed;inset:0;z-index:3500;background:#0b1220;cursor:crosshair}
    #wbToolbar{
      position:fixed;left:50%;transform:translateX(-50%);top:10px;z-index:3510;
      display:flex;gap:.5rem;align-items:center;background:#0f172a;border:1px solid #101826;
      padding:.5rem .6rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)
    }
    #wbToolbar .btn{padding:.35rem .6rem}
    #wbCanvas{position:absolute;inset:0}

    /* Command Palette */
    #cmdPal{display:none;position:fixed;inset:0;z-index:3600;background:rgba(0,0,0,.45)}
    #cmdBox{position:absolute;left:50%;top:15%;transform:translateX(-50%);width:min(800px,92vw);
      background:#0f172a;border:1px solid #101826;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.55)}
    #cmdInput{width:100%;border:0;outline:0;background:#0b1220;color:#e5e7eb;padding:14px 16px;border-radius:14px 14px 0 0}
    #cmdList{max-height:50vh;overflow:auto}
    .cmdItem{padding:.6rem .9rem;border-top:1px solid #0a0f1c;cursor:pointer}
    .cmdItem:hover,.cmdItem.active{background:#131b2d}
    .cmdHint{color:#9ca3af;font-size:.85rem;margin-left:.5rem}

    /* Terminal overlay (admin only) */
    #termDesk{display:none;position:fixed;inset:0;z-index:3400;background:rgba(0,0,0,.4)}
    #termBox{position:absolute;left:50%;top:10%;transform:translateX(-50%);width:min(900px,95vw);
      background:#0f172a;border:1px solid #101826;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.55);overflow:hidden}
    #termTop{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;background:#0b1220;border-bottom:1px solid #0a0f1c}
    #termOut{height:320px;overflow:auto;padding:.8rem;font:12.5px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;background:#0c1426}
    #termInRow{display:flex;gap:.5rem;align-items:center;padding:.6rem;border-top:1px solid #0a0f1c}
    #termIn{flex:1} .termHelp{color:#9ca3af;font-size:.85rem}

    /* Canvas Runner overlay */
    #runDesk{display:none;position:fixed;inset:0;z-index:3450;background:#0b1220}
    #runBar{display:flex;gap:.5rem;align-items:center;padding:.5rem .7rem;background:#0f172a;border-bottom:1px solid #0a0f1c}
    #runView{position:absolute; inset:42px 0 0 0; background:#0b1220}
    #runFrame{width:100%;height:100%;border:none;background:#000}

    /* Password modal */
    .modal{display:none;position:fixed;inset:0;z-index:3300}
    .modal.show{display:block}
    .modal .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
    .modal .card{position:relative; width:min(92vw,440px); background:#0f172a; border:1px solid #101826; border-radius:16px; padding:1rem; box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .modal h2{margin:.4rem 0 0; font-size:1.1rem; color:#c7d2fe}
    .modal p{margin:.25rem 0 1rem; color:#94a3b8; font-size:.95rem}
    .row{display:flex; gap:.5rem; align-items:center; margin:.5rem 0}
    .input{flex:1; background:#0b1220; border:1px solid #111827; border-radius:10px; padding:.65rem .75rem; color:#e5e7eb}
    .toggle{cursor:pointer; padding:.5rem .65rem; background:#111827; border:1px solid #1f2937; border-radius:10px; color:#cbd5e1}
    .actions{display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem}
    .primary{background:#1f2937; border:1px solid #2b3443; color:#e5e7eb; padding:.6rem .9rem; border-radius:10px; cursor:pointer}
    .secondary{background:#0b1220; border:1px solid #1f2937; color:#94a3b8; padding:.6rem .9rem; border-radius:10px; cursor:pointer}
    .err{color:#fca5a5; font-size:.9rem; min-height:1em}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="bar">
      <div class="logo">
        <img src="icon.png" alt="">
        <span>Math Help</span>
      </div>

      <div class="spacer"></div>

      <!-- Tab Cloak quick picks -->
      <button class="btn" data-title="Calculator" data-favicon="calculator-icon.png"><img src="calculator-icon.png" alt=""/>Calculator</button>
      <button class="btn" data-title="Google" data-favicon="google-favicon.png"><img src="google-favicon.png" alt=""/>Google</button>
      <button class="btn" data-title="Google Docs" data-favicon="google-docs-icon.png"><img src="google-docs-icon.png" alt=""/>Docs</button>
      <button class="btn" data-title="Google Classroom" data-favicon="classroom-favicon.png"><img src="classroom-favicon.png" alt=""/>Classroom</button>
      <button class="btn" data-title="Khan Academy" data-favicon="khan-favicon.png"><img src="khan-favicon.png" alt=""/>Khan</button>
      <button class="btn" data-title="Wikipedia" data-favicon="wikipedia-favicon.png"><img src="wikipedia-favicon.png" alt=""/>Wikipedia</button>

      <button class="btn clear" id="clearCloak">Clear</button>

      <!-- Panic UI -->
      <div class="hint" id="panicUI" style="display:flex;align-items:center;gap:.5rem;margin-left:1rem;">
        <label for="panicSelect">Panic (press <span class="kbd">-</span>):</label>
        <select id="panicSelect" title="Choose cloak for panic key">
          <option value='{"title":"Google","icon":"google-favicon.png"}'>Google</option>
          <option value='{"title":"Calculator","icon":"calculator-icon.png"}'>Calculator</option>
          <option value='{"title":"Google Docs","icon":"google-docs-icon.png"}'>Google Docs</option>
          <option value='{"title":"Google Classroom","icon":"classroom-favicon.png"}'>Google Classroom</option>
          <option value='{"title":"Khan Academy","icon":"khan-favicon.png"}'>Khan Academy</option>
          <option value='{"title":"Wikipedia","icon":"wikipedia-favicon.png"}'>Wikipedia</option>
        </select>
        <button id="panicFire" class="btn" type="button" title="Trigger panic now">Panic</button>
      </div>

      <!-- Tools (everyone) -->
      <button id="toolsBtn" class="btn">Tools</button>

      <!-- Admin only controls -->
      <div id="adminPanel">
        <span class="kbd">ADMIN</span>
        <!-- Browser button removed -->
        <button id="openTerminal" class="btn">Terminal</button>
        <label style="color:#9ca3af">BG:
          <input id="bgPick" type="color" value="#0b1220">
        </label>
        <label id="bgLabel" for="bgUpload">Upload</label>
        <input id="bgUpload" type="file" accept="image/*">
        <button id="bgClear" type="button">Clear BG</button>
      </div>
    </div>

    <!-- Main app (proxy target) -->
    <iframe id="app" title="Math Help"></iframe>
  </div>

  <!-- Tools Drawer -->
  <aside id="toolsDrawer" aria-hidden="true">
    <div id="toolsHdr">
      <h3>Tools</h3>
      <button id="toolsClose" class="btn" type="button">Close</button>
    </div>

    <div class="toolCard">
      <h4>Timer</h4>
      <div class="toolRow">
        <label>Minutes <input id="timerMin" type="number" value="5" min="0" max="180" style="width:80px" /></label>
        <button id="timerStart" class="btn" type="button">Start</button>
        <button id="timerStop"  class="btn" type="button">Stop</button>
        <button id="timerReset" class="btn" type="button">Reset</button>
      </div>
      <div class="toolRow"><strong id="timerOut">05:00</strong></div>
    </div>

    <div class="toolCard">
      <h4>Unit Converter</h4>
      <div class="toolRow">
        <label>cm <input id="cm" type="number" style="width:120px" /></label>
        <label>in <input id="inch" type="number" style="width:120px" /></label>
      </div>
      <div class="toolRow">
        <label>kg <input id="kg" type="number" style="width:120px" /></label>
        <label>lb <input id="lb" type="number" style="width:120px" /></label>
      </div>
    </div>

    <div class="toolCard">
      <h4>Fullscreen Whiteboard</h4>
      <div class="toolRow">
        <button id="wbOpen" class="btn" type="button">Open Whiteboard</button>
      </div>
    </div>

    <div class="toolCard">
      <h4>Command Palette</h4>
      <div class="toolRow"><span class="hint">Press <span class="kbd">Ctrl/⌘ + K</span> or click below</span></div>
      <div class="toolRow">
        <button id="cmdOpen" class="btn" type="button">Open Command Palette</button>
      </div>
    </div>
  </aside>

  <!-- Password Modal -->
  <div id="pwModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="backdrop" data-close></div>
    <div class="card">
      <h2>Enter password</h2>
      <p>Enter your password to unlock the page.</p>
      <div class="row">
        <input id="pwInput" class="input" type="password" placeholder="Password" autocomplete="current-password" />
        <button id="togglePw" class="toggle" type="button">Show</button>
      </div>
      <div id="pwErr" class="err"></div>
      <div class="actions">
        <button class="secondary" data-close type="button">Cancel</button>
        <button id="pwSubmit" class="primary" type="button">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Terminal (admin) -->
  <div id="termDesk" aria-hidden="true">
    <div id="termBox">
      <div id="termTop">
        <strong>Terminal (local)</strong>
        <button id="termClose" class="btn" type="button">Close</button>
      </div>
      <pre id="termOut"></pre>
      <div id="termInRow">
        <input id="termIn" class="input" type="text" placeholder=';help — or ;sudo run canvas code generation &lt;html...&gt;' />
        <span class="termHelp">Enter ↵</span>
      </div>
    </div>
  </div>

  <!-- Canvas Runner -->
  <div id="runDesk" aria-hidden="true">
    <div id="runBar">
      <span>Canvas Runner (sandboxed)</span>
      <button id="runClose" class="btn" type="button">Close</button>
    </div>
    <div id="runView">
      <iframe id="runFrame" title="Sandbox"></iframe>
    </div>
  </div>

  <!-- Fullscreen Whiteboard (unchanged UI; auto-closes when runner opens) -->
  <div id="wbDesk" aria-hidden="true">
    <canvas id="wbCanvas"></canvas>
    <div id="wbToolbar" role="toolbar" aria-label="Whiteboard tools">
      <label style="color:#cbd5e1">Color <input id="wbColor" type="color" value="#ffffff" /></label>
      <label style="color:#cbd5e1">Size <input id="wbSize" type="range" min="1" max="40" value="6" /></label>
      <button id="wbEraser" class="btn" type="button" title="Eraser (E)">Eraser</button>
      <button id="wbClear"  class="btn" type="button" title="Clear">Clear</button>
      <button id="wbSave"   class="btn" type="button" title="Save PNG (Ctrl/⌘+S)">Save</button>
      <button id="wbClose"  class="btn" type="button" title="Close (Esc)">Close</button>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="cmdPal" aria-hidden="true">
    <div id="cmdBox">
      <input id="cmdInput" type="text" placeholder="Type a command… (↑/↓, Enter, Esc)" />
      <div id="cmdList"></div>
    </div>
  </div>

  <script>
    /* ---------- constants ---------- */
    const DEFAULT_TITLE = "Math Help";
    const DEFAULT_ICON = "icon.png";
    const LS_CLOAK   = "mh_cloak";
    const LS_BG_COLOR= "mh_bg_color";
    const LS_BG_IMAGE= "mh_bg_image";

    let IS_ADMIN = false;

    /* ---------- elements ---------- */
    const panel = document.getElementById("panel");
    const frame = document.getElementById("app");
    const cover = document.getElementById("locked-cover");
    const hotspot = document.getElementById("hotspot");
    const modal = document.getElementById("pwModal");
    const pwInput = document.getElementById("pwInput");
    const pwErr = document.getElementById("pwErr");
    const adminPanel = document.getElementById("adminPanel");

    /* favicon helpers */
    function removeFavicons(){ document.querySelectorAll('link[rel~="icon"]').forEach(el => el.remove()); }
    function addIcon(href){ const l=document.createElement("link"); l.rel="icon"; l.type="image/png"; l.href=href; document.head.appendChild(l); }
    function setTab(title, iconHref){ document.title = title; removeFavicons(); addIcon(iconHref); }
    function saveCloak(title, icon){ localStorage.setItem(LS_CLOAK, JSON.stringify({title, icon})); }
    function loadCloak(){ try{ return JSON.parse(localStorage.getItem(LS_CLOAK)||"null"); }catch{ return null; } }
    function clearTab(){ localStorage.removeItem(LS_CLOAK); setTab(DEFAULT_TITLE, DEFAULT_ICON); }

    /* modal controls */
    function openModal(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); pwErr.textContent=""; pwInput.value=""; setTimeout(()=>pwInput.focus(),0); }
    function closeModal(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); pwInput.blur(); }
    document.getElementById("togglePw").addEventListener("click", (e)=>{ pwInput.type = pwInput.type==="password"?"text":"password"; e.target.textContent = pwInput.type==="password"?"Show":"Hide"; });
    modal.addEventListener("click",(e)=>{ if (e.target.dataset.close !== undefined) closeModal(); });
    document.addEventListener("keydown",(e)=>{ if (e.key==="Escape" && modal.classList.contains("show")) closeModal(); });

    async function submitPassword(){
      const pass = pwInput.value.trim();
      if (!pass){ pwErr.textContent="Password required."; return; }
      pwErr.textContent="Checking…";
      try {
        const r = await fetch("/.netlify/functions/unlock",{ method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({password:pass}) });
        const { ok, admin } = await r.json();
        if (ok){
          IS_ADMIN = !!admin;
          adminPanel.style.display = IS_ADMIN ? "flex" : "none";
          closeModal();
          loadApp();
        } else {
          pwErr.textContent = "Invalid password.";
        }
      } catch (e){
        pwErr.textContent = "Network error.";
      }
    }
    document.getElementById("pwSubmit").addEventListener("click", submitPassword);
    pwInput.addEventListener("keydown",(e)=>{ if (e.key==="Enter") submitPassword(); });

    /* load app (always calculator or your app) */
    function loadApp(){
      const url = "https://www.desmos.com/scientific?lang=en"; // example
      frame.src = url;
    }

    /* initial state */
    setTab(DEFAULT_TITLE, DEFAULT_ICON);
    loadApp();

    /* cloak quick picks */
    document.querySelectorAll('.bar .btn[data-title]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const title = btn.getAttribute("data-title");
        const icon  = btn.getAttribute("data-favicon");
        saveCloak(title, icon);
        setTab(title, icon);
      });
    });
    document.getElementById("clearCloak").addEventListener("click", clearTab);

    /* panic key & UI */
    const panicSelect = document.getElementById("panicSelect");
    const panicFire   = document.getElementById("panicFire");
    let panicChoice = JSON.parse(panicSelect.value);
    panicSelect.addEventListener("change", ()=> panicChoice = JSON.parse(panicSelect.value));
    function triggerPanic(){
      saveCloak(panicChoice.title, panicChoice.icon);
      setTab(panicChoice.title, panicChoice.icon);
      frame.src = "about:blank";
    }
    panicFire.addEventListener("click", triggerPanic);
    document.addEventListener("keydown",(e)=>{ if (e.key === "-"){ e.preventDefault(); triggerPanic(); } });

    /* Tools Drawer */
    const toolsBtn   = document.getElementById("toolsBtn");
    const toolsClose = document.getElementById("toolsClose");
    const toolsDrawer= document.getElementById("toolsDrawer");
    toolsBtn.addEventListener("click", ()=> toolsDrawer.classList.add("open"));
    toolsClose.addEventListener("click", ()=> toolsDrawer.classList.remove("open"));

    /* Timer */
    const timerMin   = document.getElementById("timerMin");
    const timerOut   = document.getElementById("timerOut");
    const timerStart = document.getElementById("timerStart");
    const timerStop  = document.getElementById("timerStop");
    const timerReset = document.getElementById("timerReset");
    let timerId = null, timerLeft = 0;

    function formatTime(s){ const m = Math.floor(s/60), ss = s % 60; return `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`; }
    function renderTimer(){ timerOut.textContent = formatTime(timerLeft); }
    function tick(){
      if (timerLeft > 0){ timerLeft--; renderTimer(); }
      else { clearInterval(timerId); timerId=null; new AudioContext().resume().then(()=>{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type="sine"; o.frequency.setValueAtTime(880,ctx.currentTime); o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop();ctx.close();},300);}); }
    }
    function startTimer(){
      if (timerId) return;
      timerLeft = Math.max(0, Math.min(180, Number(timerMin.value))) * 60;
      renderTimer();
      timerId = setInterval(tick, 1000);
    }
    function stopTimer(){ if (timerId){ clearInterval(timerId); timerId=null; } }
    function resetTimer(){ stopTimer(); timerLeft = Math.max(0, Math.min(180, Number(timerMin.value))) * 60; renderTimer(); }
    timerStart.addEventListener("click", startTimer);
    timerStop.addEventListener("click", stopTimer);
    timerReset.addEventListener("click", resetTimer);
    timerMin.addEventListener("change", resetTimer);
    renderTimer();

    // Unit converter
    const cm   = document.getElementById("cm");
    const inch = document.getElementById("inch");
    const kg   = document.getElementById("kg");
    const lb   = document.getElementById("lb");
    function round(x){ return Math.round(x * 1000) / 1000; }
    cm.addEventListener("input",  ()=> { const v = Number(cm.value||0);    inch.value = v ? round(v/2.54) : ""; });
    inch.addEventListener("input",()=> { const v = Number(inch.value||0);  cm.value   = v ? round(v*2.54) : ""; });
    kg.addEventListener("input",  ()=> { const v = Number(kg.value||0);    lb.value   = v ? round(v*2.2046226218) : ""; });
    lb.addEventListener("input",  ()=> { const v = Number(lb.value||0);    kg.value   = v ? round(v/2.2046226218) : ""; });

    /* ===== Whiteboard ===== */
    const wbDesk   = document.getElementById("wbDesk");
    const wbCanvas = document.getElementById("wbCanvas");
    const wbColor  = document.getElementById("wbColor");
    const wbSize   = document.getElementById("wbSize");
    const wbEraser = document.getElementById("wbEraser");
    const wbClear  = document.getElementById("wbClear");
    const wbSave   = document.getElementById("wbSave");
    const wbClose  = document.getElementById("wbClose");
    let wbCtx, drawing=false, lastX=0, lastY=0, erasing=false;

    function wbResize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      wbCanvas.width  = Math.floor(wbDesk.clientWidth  * dpr);
      wbCanvas.height = Math.floor(wbDesk.clientHeight * dpr);
      wbCtx = wbCanvas.getContext("2d");
      wbCtx.scale(dpr, dpr);
      wbCtx.lineCap = "round";
      wbCtx.lineJoin = "round";
      wbCtx.strokeStyle = wbColor.value;
      wbCtx.lineWidth = Number(wbSize.value);
      wbCtx.fillStyle = "#0b1220";
      wbCtx.fillRect(0,0,wbDesk.clientWidth,wbDesk.clientHeight);
      const saved = localStorage.getItem("mh_whiteboard_img");
      if (saved) { const img = new Image(); img.onload = ()=>{ wbCtx.drawImage(img,0,0,wbDesk.clientWidth,wbDesk.clientHeight); }; img.src = saved; }
    }
    function wbOpenDesk(){ wbDesk.style.display = "block"; wbDesk.setAttribute("aria-hidden","false"); wbResize(); }
    function wbCloseDesk(){
      try { localStorage.setItem("mh_whiteboard_img", wbCanvas.toDataURL("image/png")); } catch {}
      wbDesk.style.display = "none";
      wbDesk.setAttribute("aria-hidden","true");
    }
    function wbPos(e){
      const r = wbCanvas.getBoundingClientRect();
      const p = e.touches ? e.touches[0] : e;
      return { x: p.clientX - r.left, y: p.clientY - r.top };
    }
    function wbDrawTo(x,y){
      wbCtx.lineWidth = erasing ? 26 : Number(wbSize.value);
      wbCtx.strokeStyle = erasing ? "#0b1220" : wbColor.value;
      wbCtx.beginPath();
      wbCtx.moveTo(lastX,lastY);
      wbCtx.lineTo(x,y);
      wbCtx.stroke();
      lastX=x; lastY=y;
    }
    wbCanvas.addEventListener("mousedown",(e)=>{ drawing=true; const p=wbPos(e); lastX=p.x; lastY=p.y; });
    wbCanvas.addEventListener("mousemove",(e)=>{ if (!drawing) return; const p=wbPos(e); wbDrawTo(p.x,p.y); });
    wbCanvas.addEventListener("mouseup",  ()=> drawing=false);
    wbCanvas.addEventListener("mouseleave",()=> drawing=false);
    wbCanvas.addEventListener("touchstart",(e)=>{ drawing=true; const p=wbPos(e); lastX=p.x; lastY=p.y; e.preventDefault(); }, {passive:false});
    wbCanvas.addEventListener("touchmove", (e)=>{ if (!drawing) return; const p=wbPos(e); wbDrawTo(p.x,p.y); e.preventDefault(); }, {passive:false});
    wbCanvas.addEventListener("touchend",  ()=> drawing=false);

    wbColor.addEventListener("change", ()=> wbCtx.strokeStyle = wbColor.value);
    wbSize.addEventListener("change", ()=> wbCtx.lineWidth   = Number(wbSize.value));
    wbEraser.addEventListener("click", ()=>{ erasing = !erasing; wbEraser.textContent = erasing ? "Eraser ✓" : "Eraser"; });
    wbClear.addEventListener("click", ()=>{ wbCtx.clearRect(0,0,wbCanvas.width,wbCanvas.height); localStorage.removeItem("mh_whiteboard_img"); });
    wbSave.addEventListener("click", ()=>{
      const url = wbCanvas.toDataURL("image/png");
      const a = document.createElement("a"); a.href = url; a.download = "whiteboard.png"; a.click();
    });
    wbClose.addEventListener("click", wbCloseDesk);

    /* ===== Command Palette ===== */
    const cmdPal   = document.getElementById("cmdPal");
    const cmdInput = document.getElementById("cmdInput");
    const cmdList  = document.getElementById("cmdList");
    const actions = [
      { id:"tools",    label:"Open Tools drawer",        run: ()=> document.getElementById("toolsBtn").click() },
      { id:"wb",       label:"Open Whiteboard",          run: ()=> wbOpenDesk() },
      // Browser command removed
      { id:"cloak:g",  label:"Set cloak → Google",       run: ()=> { setTab("Google","google-favicon.png"); saveCloak("Google","google-favicon.png"); } },
      { id:"cloak:c",  label:"Set cloak → Calculator",   run: ()=> { setTab("Calculator","calculator-icon.png"); saveCloak("Calculator","calculator-icon.png"); } },
      { id:"cloak:d",  label:"Set cloak → Google Docs",  run: ()=> { setTab("Google Docs","google-docs-icon.png"); saveCloak("Google Docs","google-docs-icon.png"); } },
      { id:"logout",   label:"Lock page (logout)",       run: ()=> { fetch("/.netlify/functions/logout",{credentials:"include"}).finally(()=>location.reload()); } },
    ];
    function openCmd(){
      cmdPal.style.display = "block";
      cmdPal.setAttribute("aria-hidden","false");
      cmdInput.value = "";
      renderCmd("");
      setTimeout(()=>cmdInput.focus(),0);
    }
    function closeCmd(){ cmdPal.style.display = "none"; cmdPal.setAttribute("aria-hidden","true"); }
    function renderCmd(q){
      const qq = q.trim().toLowerCase();
      const hits = actions.filter(a => a.label.toLowerCase().includes(qq) && (a.id.includes("admin") ? IS_ADMIN : true));
      cmdList.innerHTML = "";
      hits.forEach((a, idx)=>{
        const div = document.createElement("div");
        div.className = "cmdItem" + (idx===0?" active":"");
        div.tabIndex = 0;
        div.textContent = a.label;
        div.addEventListener("click", ()=>{ a.run(); closeCmd(); });
        cmdList.appendChild(div);
      });
    }
    document.getElementById("cmdOpen").addEventListener("click", openCmd);
    document.addEventListener("keydown",(e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){ e.preventDefault(); openCmd(); }
      if (e.key==="Escape" && cmdPal.style.display==="block"){ e.preventDefault(); closeCmd(); }
    });
    cmdInput.addEventListener("input", ()=> renderCmd(cmdInput.value));
    cmdInput.addEventListener("keydown",(e)=>{
      const items = Array.from(cmdList.querySelectorAll(".cmdItem"));
      let ix = items.findIndex(el=>el.classList.contains("active"));
      if (e.key==="ArrowDown"){ ix = Math.min(items.length-1, Math.max(0, ix+1)); items.forEach(el=>el.classList.remove("active")); if (items[ix]) items[ix].classList.add("active"); e.preventDefault(); }
      if (e.key==="ArrowUp"){ ix = Math.max(0, ix-1); items.forEach(el=>el.classList.remove("active")); if (items[ix]) items[ix].classList.add("active"); e.preventDefault(); }
      if (e.key==="Enter"){ const el = cmdList.querySelector(".cmdItem.active"); if (el){ el.click(); } }
    });

    /* Admin Terminal */
    const termDesk = document.getElementById("termDesk");
    const termBox  = document.getElementById("termBox");
    const termOut  = document.getElementById("termOut");
    const termInEl = document.getElementById("termIn");
    const termClose= document.getElementById("termClose");
    document.getElementById("openTerminal").addEventListener("click", ()=>{ termDesk.style.display="block"; termDesk.setAttribute("aria-hidden","false"); termInEl.focus(); });
    termClose.addEventListener("click", ()=>{ termDesk.style.display="none"; termDesk.setAttribute("aria-hidden","true"); termInEl.blur(); });

    const commands = {
      help(){ println("Commands: help, clear, echo &lt;text&gt;, sudo run &lt;html&gt;"); },
      clear(){ termOut.textContent=""; },
      echo(...rest){ println(rest.join(" ")); },
      "sudo run"(...rest){
        const html = rest.join(" ");
        if (!html){ println("Usage: ;sudo run &lt;html...&gt;"); return; }
        openRunner(html);
      }
    };
    function println(s=""){ termOut.innerHTML += s + "\\n"; termOut.scrollTop = termOut.scrollHeight; }

    function handleCommand(line){
      const raw = line.trim();
      if (!raw) return;
      const parts = raw.startsWith(";") ? raw.slice(1) : raw;
      const cmd = parts.startsWith("sudo run") ? "sudo run" : parts.split(/\s+/)[0];
      const rest = parts.startsWith("sudo run") ? parts.slice("sudo run".length).trim().split(/\s+/) : parts.split(/\s+/).slice(1);
      if (commands[cmd]) commands[cmd](...rest);
      else println("Unknown command.");
    }

    function openRunner(html){
      const doc = `
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Canvas</title><style>html,body{height:100%;margin:0}body{background:#111;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}</style></head><body>${html}</body></html>`;
      const blob = new Blob([doc], {type:"text/html"});
      const url = URL.createObjectURL(blob);
      document.getElementById("runFrame").src = url;
      document.getElementById("runDesk").style.display = "block";
      document.getElementById("runDesk").setAttribute("aria-hidden","false");
    }
    document.getElementById("runClose").addEventListener("click", ()=>{
      const f = document.getElementById("runFrame");
      try { URL.revokeObjectURL(f.src); } catch {}
      f.src = "about:blank";
      document.getElementById("runDesk").style.display = "none";
      document.getElementById("runDesk").setAttribute("aria-hidden","true");
    });

    /* Admin BG controls */
    const bgPick   = document.getElementById("bgPick");
    const bgUpload = document.getElementById("bgUpload");
    const bgClear  = document.getElementById("bgClear");
    function applyBackground(){
      const color = localStorage.getItem(LS_BG_COLOR) || "#0b1220";
      const img   = localStorage.getItem(LS_BG_IMAGE);
      document.body.style.background = img ? `url(${img}) center/cover no-repeat fixed` : color;
    }
    bgPick.addEventListener("input", (e)=>{ localStorage.setItem(LS_BG_COLOR, e.target.value); applyBackground(); });
    bgUpload.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { localStorage.setItem(LS_BG_IMAGE, reader.result); applyBackground(); }
        catch { alert("Could not save image (storage limit)."); }
      };
      reader.readAsDataURL(file);
      e.target.value = "";
    });
    bgClear.addEventListener("click", ()=>{ localStorage.removeItem(LS_BG_IMAGE); applyBackground(); });

    function openModalIfNeeded(){
      // If server requires login, show modal; otherwise show admin if cookie present
      fetch("/.netlify/functions/unlock", {method:"POST"}).catch(()=>{}); // noop to warm
    }

    // Whiteboard button
    document.getElementById("wbOpen").addEventListener("click", wbOpenDesk);

    // Command Palette toggle
    document.getElementById("cmdOpen").addEventListener("click", openCmd);

    // Keyboard closes
    const runDesk = document.getElementById("runDesk");
    document.addEventListener("keydown",(e)=>{
      if (runDesk.style.display==="block" && e.key==="Escape"){ e.preventDefault(); document.getElementById("runClose").click(); }
    });

    // Terminal input
    document.getElementById("termIn").addEventListener("keydown",(e)=>{
      if (e.key === "Enter"){
        handleCommand(termInEl.value);
        termInEl.value = "";
      } else if (e.key === "Escape"){
        closeTerm();
      }
    });

    document.addEventListener("keydown",(e)=>{
      if (runDesk.style.display==="block" && e.key==="Escape"){ e.preventDefault(); closeRunner(); }
      if (termDesk.style.display==="block" && e.key==="Escape"){ e.preventDefault(); closeTerm(); }
    });
  </script>
</body>
</html>
